---
import AnimatedServiceCard from "./AnimatedServiceCard.jsx";

export interface Props {
  currentServiceTitle?: string;
}

const { currentServiceTitle } = Astro.props;

const allServices = [
  {
    title: "Diseño web y desarrollo",
    description: "Plataformas web optimizadas para máxima conversión.",
    image:
      "https://res.cloudinary.com/dgkdq8kzk/image/upload/v1771930277/office_team_sdjvxo.jpg",
    variant: "image",
    imageClassName: "object-cover object-bottom",
    href: "/diseno-y-desarrollo-web",
  },
  {
    title: "Rebranding e identidad",
    description:
      "Identidad visual que refleja autoridad y profesionalismo comercial.",
    image:
      "https://res.cloudinary.com/dgkdq8kzk/image/upload/v1771929812/rebranding_al9jxt.webp",
    variant: "image",
    imageClassName: "object-cover object-bottom",
    href: "/rebranding-identidad",
  },
  {
    title: "Chatbots Personalizados",
    description:
      "Asistentes virtuales con IA para responder consultas y ventas 24/7.",
    image:
      "https://res.cloudinary.com/dgkdq8kzk/image/upload/v1771930346/chatbots_v2_sltcgz.png",
    variant: "image",
    imageClassName: "object-cover object-bottom",
    href: "/chatbots-personalizados",
  },
  {
    title: "Servicios para Negocios Locales",
    description:
      "Atención y procesos óptimos para peluquerías y salones de belleza.",
    image:
      "https://res.cloudinary.com/dgkdq8kzk/image/upload/v1771930116/salon_v2_dbpsof.png",
    variant: "image",
    imageClassName: "object-cover object-bottom",
    href: "/servicios-negocios-locales",
  },
  {
    title: "Automatización de Procesos",
    description:
      "Flujos de trabajo automáticos que eliminan tareas manuales repetitivas.",
    image:
      "https://res.cloudinary.com/dgkdq8kzk/image/upload/v1771948015/Gemini_Generated_Image_rpyoearpyoearpyo_pivghj.webp",
    variant: "image",
    imageClassName: "object-cover object-bottom",
    href: "/automatizacion-de-procesos",
  },
  {
    title: "Gestión y Hostelería",
    description:
      "Sistemas eficientes para reservas y marketing en cafeterías y restaurantes.",
    image:
      "https://res.cloudinary.com/dgkdq8kzk/image/upload/v1771929988/cafe_v2_nrrwj7.webp",
    variant: "image",
    imageClassName: "object-cover object-bottom",
    href: "/gestion-hosteleria",
  },
];

const filteredServices = allServices.filter(
  (s) => s.title !== currentServiceTitle,
);
---

<div class="w-full relative max-w-[1400px] mx-auto group carousel-wrapper">
  <!-- Gradient mask to indicate more content to the right -->
  <div
    class="pointer-events-none absolute right-0 top-0 bottom-0 w-16 md:w-32 bg-gradient-to-l from-gray-50/90 to-transparent z-10 transition-opacity"
  >
  </div>

  <!-- Left mask (optional, shown only when scrolling, but we keep it simple or just use right) -->
  <div
    class="pointer-events-none absolute left-0 top-0 bottom-0 w-8 md:w-16 bg-gradient-to-r from-gray-50/90 to-transparent z-10"
  >
  </div>

  <div
    class="grab-slider flex overflow-x-auto gap-6 sm:gap-8 pb-14 pt-8 snap-x snap-mandatory hide-scrollbar px-4 md:px-8 cursor-grab"
  >
    {
      filteredServices.map((service, index) => (
        <div class="shrink-0 w-[85vw] sm:w-[320px] snap-center">
          <AnimatedServiceCard
            client:visible
            title={service.title}
            description={service.description}
            variant={service.variant}
            image={service.image}
            imageClassName={service.imageClassName}
            index={index}
            className="aspect-[3/4] h-auto w-full max-h-[450px]"
            href={service.href}
          />
        </div>
      ))
    }
    <!-- Espaciador extra al final para que la última tarjeta no quede pegada bajo el gradiente -->
    <div class="shrink-0 w-12 md:w-24"></div>
  </div>

  <!-- Puntos de slide (Dots) -->
  <div
    class="absolute bottom-0 left-0 right-0 flex justify-center items-center gap-2 pb-6 carousel-dots z-20 pointer-events-none"
  >
    {
      filteredServices.map((_, index) => (
        <button
          class={`w-2.5 h-2.5 rounded-full transition-colors duration-300 carousel-dot pointer-events-auto ${
            index === 0 ? "bg-primary" : "bg-gray-300 hover:bg-gray-400"
          }`}
          aria-label={`Ir a tarjeta ${index + 1}`}
          type="button"
        />
      ))
    }
  </div>
</div>

<script>
  // @ts-nocheck
  document.addEventListener("astro:page-load", () => {
    const wrappers = document.querySelectorAll(".carousel-wrapper");

    wrappers.forEach((wrapperNode) => {
      const slider = wrapperNode.querySelector(".grab-slider");
      if (!slider) return;

      let isDown = false;
      let startX = 0;
      let scrollLeft = 0;
      let isDragging = false;

      const startDrag = (e) => {
        isDown = true;
        isDragging = false;
        slider.classList.add("cursor-grabbing");
        slider.classList.remove("cursor-grab", "snap-x", "snap-mandatory");
        startX = e.pageX - slider.offsetLeft;
        scrollLeft = slider.scrollLeft;
      };

      const stopDrag = () => {
        isDown = false;
        slider.classList.remove("cursor-grabbing");
        slider.classList.add("cursor-grab", "snap-x", "snap-mandatory");
      };

      const moveDrag = (e) => {
        if (!isDown) return;
        const x = e.pageX - slider.offsetLeft;
        const walk = (x - startX) * 2;

        if (Math.abs(walk) > 5) {
          isDragging = true;
          e.preventDefault();
        }

        slider.scrollLeft = scrollLeft - walk;
      };

      slider.addEventListener("mousedown", startDrag);
      slider.addEventListener("mouseleave", stopDrag);
      slider.addEventListener("mouseup", stopDrag);
      slider.addEventListener("mousemove", moveDrag);

      // Prevent click if we dragged
      slider.addEventListener(
        "click",
        (e) => {
          if (isDragging) {
            e.preventDefault();
            e.stopPropagation();
          }
        },
        true,
      );

      slider.addEventListener("dragstart", (e) => {
        e.preventDefault();
      });

      // Dots Intersection Observer Logic
      const cards = Array.from(
        slider.querySelectorAll(".snap-center:not(.w-12)"),
      );
      const dotsContainer = wrapperNode.querySelector(".carousel-dots");
      const dots = dotsContainer
        ? Array.from(dotsContainer.querySelectorAll(".carousel-dot"))
        : [];

      if (cards.length > 0 && dots.length > 0) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                const index = cards.indexOf(entry.target);
                if (index !== -1 && dots[index]) {
                  dots.forEach((d) => {
                    d.classList.remove("bg-primary");
                    d.classList.add("bg-gray-300");
                  });
                  dots[index].classList.remove("bg-gray-300");
                  dots[index].classList.add("bg-primary");
                }
              }
            });
          },
          {
            root: slider,
            threshold: 0.5,
          },
        );

        cards.forEach((card) => {
          observer.observe(card);
        });

        // Clic on dots
        dots.forEach((dot, index) => {
          dot.addEventListener("click", () => {
            cards[index].scrollIntoView({
              behavior: "smooth",
              block: "nearest",
              inline: "center",
            });
          });
        });
      }
    });
  });
</script>
<style>
  /* Ocultar barra de scroll nativa */
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
