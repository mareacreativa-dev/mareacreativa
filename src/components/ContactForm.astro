<div
  class="bg-white border-2 border-[#0e44f9]/20 p-6 md:p-8 lg:p-10 rounded-[24px] md:rounded-[32px] shadow-2xl shadow-blue-900/5 relative z-20"
>
  <div class="mb-8 lg:mb-10">
    <h2
      class="text-2xl md:text-3xl font-bold text-gray-900 mb-2 tracking-tight"
    >
      Formulario Directo
    </h2>
    <p class="text-gray-500 text-base">
      ¬øPreparado para arrancar? Cu√©ntanos tu desaf√≠o y nos pondremos en
      contacto.
    </p>
  </div>

  <form id="contactForm" class="space-y-5">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <div>
        <label
          for="name"
          class="block text-xs font-semibold text-gray-700 mb-2 uppercase tracking-wide"
        >
          Nombre completo
        </label>
        <input
          type="text"
          id="name"
          name="firstname"
          placeholder="Ej: Laura M√©ndez"
          class="w-full px-4 py-3 text-sm bg-gray-50 border-transparent rounded-[12px] focus:bg-white focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all outline-none"
          required
        />
      </div>
      <div>
        <label
          for="email"
          class="block text-xs font-semibold text-gray-700 mb-2 uppercase tracking-wide"
        >
          Correo Electr√≥nico
        </label>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="hola@tuempresa.com"
          class="w-full px-4 py-3 text-sm bg-gray-50 border-transparent rounded-[12px] focus:bg-white focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all outline-none"
          required
        />
      </div>
    </div>

    <div>
      <label
        for="phone"
        class="block text-xs font-semibold text-gray-700 mb-2 uppercase tracking-wide"
      >
        Tel√©fono <span class="text-gray-400 font-normal lowercase"
          >(opcional)</span
        >
      </label>
      <input
        type="text"
        id="phone"
        name="telefono"
        placeholder="+34 600 000 000"
        class="w-full px-4 py-3 text-sm bg-gray-50 border-transparent rounded-[12px] focus:bg-white focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all outline-none"
      />
    </div>

    <div>
      <label
        for="message"
        class="block text-xs font-semibold text-gray-700 mb-2 uppercase tracking-wide"
      >
        Detalles del proyecto
      </label>
      <textarea
        id="message"
        name="descripcion"
        rows="3"
        placeholder="H√°blanos sobre los problemas actuales y tus metas a lograr..."
        class="w-full px-4 py-3 text-sm bg-gray-50 border-transparent rounded-[12px] focus:bg-white focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all outline-none resize-none"
      ></textarea>
    </div>

    <!-- Audio Record Section -->
    <div class="-mt-2">
      <div class="flex items-center gap-3">
        <button
          type="button"
          id="recordButton"
          class="flex flex-1 items-center justify-center gap-2 bg-gray-50 text-gray-700 font-medium text-sm px-4 py-3 rounded-[12px] border border-gray-200 hover:bg-gray-100 transition-all"
        >
          <svg
            id="micIcon"
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-blue-600"
            ><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"
            ></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line
              x1="12"
              x2="12"
              y1="19"
              y2="22"></line>
          </svg>
          <span id="recordButtonText">A√±adir nota de voz (Opcional)</span>
        </button>

        <div
          id="audioPlaybackContainer"
          class="hidden items-center gap-3 w-full bg-blue-50/50 px-3 py-2 rounded-[12px] border border-blue-100 border-dashed"
        >
          <audio
            id="audioPlayback"
            controls
            class="h-8 w-full max-w-[200px] flex-grow"></audio>
          <button
            type="button"
            id="deleteAudioButton"
            class="text-red-500 p-1.5 hover:bg-red-100 rounded-full transition-colors shrink-0"
            title="Eliminar audio"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path d="M3 6h18"></path><path
                d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path
                d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line
                x1="10"
                x2="10"
                y1="11"
                y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line>
            </svg>
          </button>
        </div>
      </div>
      <p
        id="recordStatusMessage"
        class="text-xs text-red-500 mt-2 font-medium hidden text-center animate-pulse"
      >
        üéôÔ∏è Grabando audio... Haz clic de nuevo para detener.
      </p>
    </div>

    <!-- Honeypot (Anti-Spam invisible para usuarios) -->
    <div class="absolute left-[-5000px]" aria-hidden="true">
      <input
        type="text"
        id="website_url"
        name="website_url"
        tabindex="-1"
        autocomplete="off"
        placeholder="Deja este campo en blanco"
      />
    </div>

    <button
      type="submit"
      class="w-full flex items-center justify-center gap-2 bg-[#0e44f9] text-white font-semibold text-base px-6 py-4 rounded-full hover:bg-blue-700 transition-all shadow-xl shadow-blue-500/20 active:scale-[0.98]"
    >
      <span>Enviar Solicitud</span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>

    <p
      id="responseMessage"
      class="mt-5 text-center text-sm font-semibold text-[#0ebf6e] bg-[#0ebf6e]/10 py-3 rounded-[12px] hidden"
    >
      ¬°Solicitud enviada! Nos pondremos en contacto pronto.
    </p>
  </form>
</div>

<script>
  async function enviarAFormSubmit(datos) {
    const url = "https://formsubmit.co/ajax/8d86a7e2a5da3f4edcc0272444052849";

    const data = {
      Nombre: datos.name,
      Email: datos.email,
      Tel√©fono: datos.phone || "No proporcionado",
      "Detalles del Proyecto": datos.message,
      _subject: `Nueva solicitud de proyecto de ${datos.name}`,
      _template: "box",
    };

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      throw new Error("Error enviando el correo");
    }
  }

  async function enviarATelegram(datos, audioBlob) {
    const token = "8396220653:AAGdOZCOCn3nXnpl6VCU02XMUqEUIGdfoow";
    const chatId = "7202779540"; // ID del chat donde quieres recibir los leads

    // 1. Enviar el mensaje de texto primero
    const urlText = `https://api.telegram.org/bot${token}/sendMessage`;
    const mensaje =
      `üö® *Nueva Solicitud Web*\n\n` +
      `üë§ *Nombre:* ${datos.name}\n` +
      `üìß *Email:* ${datos.email}\n` +
      `üìû *Tel√©fono:* ${datos.phone || "No proporcionado"}\n\n` +
      `üìù *Detalles:*\n${
        datos.message || "*(Enviado por nota de voz adjunta)*"
      }`;

    try {
      await fetch(urlText, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: chatId,
          text: mensaje,
          parse_mode: "Markdown",
        }),
      });

      // 2. Si hay un audio, enviarlo como Voice Message
      if (audioBlob) {
        const urlVoice = `https://api.telegram.org/bot${token}/sendVoice`;
        const formData = new FormData();
        formData.append("chat_id", chatId);
        formData.append("voice", audioBlob, "nota_de_voz.webm");
        formData.append("caption", `üéôÔ∏è Audio adjunto de ${datos.name}`);

        await fetch(urlVoice, {
          method: "POST",
          body: formData,
        });
      }
    } catch (error) {
      console.error("Error de red enviando a Telegram:", error);
    }
  }

  // --- L√≥gica de Grabaci√≥n de Audio ---
  let mediaRecorder = null;
  let audioChunks = [];
  let audioBlob = null;
  let isRecording = false;

  const recordButton = document.getElementById("recordButton");
  const recordButtonText = document.getElementById("recordButtonText");
  const recordStatusMessage = document.getElementById("recordStatusMessage");
  const micIcon = document.getElementById("micIcon");
  const audioPlaybackContainer = document.getElementById(
    "audioPlaybackContainer",
  );
  const audioPlayback = document.getElementById("audioPlayback");
  const deleteAudioButton = document.getElementById("deleteAudioButton");

  if (recordButton) {
    recordButton.addEventListener("click", async () => {
      if (isRecording) {
        mediaRecorder.stop();
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const audioUrl = URL.createObjectURL(audioBlob);
          audioPlayback.src = audioUrl;

          recordButton.classList.add("hidden");
          recordStatusMessage.classList.add("hidden");
          audioPlaybackContainer.classList.remove("hidden");
          audioPlaybackContainer.classList.add("flex");

          isRecording = false;
          stream.getTracks().forEach((track) => track.stop()); // Apagar micr√≥fono
        };

        mediaRecorder.start();
        isRecording = true;

        // Estilos visuales de "Grabando..."
        recordButton.classList.remove(
          "bg-gray-50",
          "text-gray-700",
          "border-gray-200",
        );
        recordButton.classList.add(
          "bg-red-50",
          "text-red-600",
          "border-red-200",
        );
        micIcon.classList.remove("text-blue-600");
        micIcon.classList.add("text-red-600");
        recordButtonText.innerText = "Detener grabaci√≥n";
        recordStatusMessage.classList.remove("hidden");
      } catch (err) {
        console.error("Error al acceder al micr√≥fono:", err);
        alert(
          "Para enviar notas de voz, por favor permite el acceso al micr√≥fono en tu navegador.",
        );
      }
    });
  }

  if (deleteAudioButton) {
    deleteAudioButton.addEventListener("click", () => {
      audioBlob = null;
      audioPlayback.src = "";

      audioPlaybackContainer.classList.add("hidden");
      audioPlaybackContainer.classList.remove("flex");

      recordButton.classList.remove(
        "hidden",
        "bg-red-50",
        "text-red-600",
        "border-red-200",
      );
      recordButton.classList.add(
        "bg-gray-50",
        "text-gray-700",
        "border-gray-200",
      );
      micIcon.classList.remove("text-red-600");
      micIcon.classList.add("text-blue-600");
      recordButtonText.innerText = "A√±adir nota de voz (Opcional)";
    });
  }
  // ------------------------------------

  document
    .getElementById("contactForm")
    .addEventListener("submit", async function (event) {
      event.preventDefault();
      const form = event.target;
      const honeypotInput = document.getElementById("website_url").value;

      if (honeypotInput !== "") {
        console.warn("Spam detectado y bloqueado.");
        return;
      }

      const mensajeTexto = document.getElementById("message").value;
      if (!mensajeTexto.trim() && !audioBlob) {
        alert(
          "Por favor escribe los detalles de tu proyecto o a√±√°denos una nota de voz.",
        );
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      const oldText = btn.innerHTML;
      btn.innerHTML = "Enviando...";
      btn.disabled = true;

      const datosFormulario = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        message: mensajeTexto,
      };

      try {
        await Promise.all([
          enviarAFormSubmit(datosFormulario),
          enviarATelegram(datosFormulario, audioBlob),
        ]);

        document.getElementById("responseMessage").classList.remove("hidden");
        form.reset();

        // Limpiar el audio si hab√≠a uno
        if (deleteAudioButton) deleteAudioButton.click();
      } catch (error) {
        console.error("Error al enviar el mensaje:", error);
        alert("Hubo un error al enviar el formulario. Int√©ntalo de nuevo.");
      } finally {
        btn.innerHTML = oldText;
        btn.disabled = false;
      }
    });
</script>
